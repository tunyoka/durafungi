<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Fresh Mushrooms – DuraFungi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'Montserrat';
            src: url('/assets/fonts/MontserratVariableFontwght.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --black: #1F1F1F;
            --white: #F5F5F5;
            --beige: #D8C3A5;
            --green: #3B7A57;
            --rust: #8B5E3C;
            --silver: #C0C0C0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #ffffff;
            color: var(--black);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .text-fresh {
            color: var(--green);
        }

        .text-gourmet {
            color: var(--rust);
        }

        .text-mushrooms {
            color: var(--black);
        }

        header {
            background: linear-gradient(to bottom, var(--beige) 0%, #fff 100%);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-link:hover {
            color: var(--green);
        }

        .nav-toggle {
            display: block;
            cursor: pointer;
            padding: 0.5rem;
        }

        .nav-toggle-line {
            width: 24px;
            height: 2px;
            background: var(--black);
            margin: 5px 0;
        }

        #mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        #mobile-menu.open {
            display: flex;
        }

        @media (min-width: 768px) {
            .nav-toggle {
                display: none;
            }

            #mobile-menu {
                display: none !important;
            }
        }

        .page-section {
            padding: 2rem 1.25rem;
        }

        .plan-card {
            background: #fff;
            border: 2px solid #e5e7eb;
            padding: 1.25rem 1rem;
            border-radius: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px;
            transition: all 0.2s;
        }

        .plan-card.added {
            border-color: var(--green);
            background-color: #f0fdf4;
        }

        .add-plan-btn {
            margin-top: 1rem;
            background-color: var(--green);
            color: white;
            font-weight: bold;
            padding: 0.875rem;
            border-radius: 0.75rem;
            transition: opacity 0.15s ease;
        }

        .add-plan-btn.added {
            background-color: white;
            color: var(--green);
            border: 2px solid var(--green);
        }

        .add-plan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-card {
            background: #fff;
            border: 2px solid transparent;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.12s ease;
        }

        .product-card.has-items {
            border-color: var(--green);
            background-color: #f0fdf4;
        }

        .product-card.flash {
            transform: translateY(-2px);
        }

        .qty-input {
            width: 44px;
            text-align: center;
            font-weight: bold;
            font-size: 1.25rem;
            background: transparent;
            border: none;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #f3f4f6;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.25rem;
            touch-action: manipulation;
            user-select: none;
        }

        /* Mini-cart styles */
        #cart-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 340px;
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 200;
        }

        #cart-dropdown.open {
            display: block;
        }

        #proceed-btn {
            background-color: #9ca3af;
            width: 100%;
        }

        #proceed-btn:not(:disabled) {
            background-color: var(--green);
        }

        #proceed-btn:disabled {
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        /* Toast */
        #toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            background: rgba(31, 31, 31, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            max-width: calc(100% - 24px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #toast.show {
            opacity: 1;
        }

        @media (max-width: 767px) {
            .page-section {
                padding: 1.5rem 1rem;
            }

            header {
                padding: 0.65rem 1rem;
            }

            #cart-dropdown {
                width: 100%;
                left: 0;
                right: 0;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <header>
        <a href="index.html">
            <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/logo.png" alt="Dura Fungi"
                class="h-10 md:h-12" />
        </a>

        <nav class="hidden md:flex gap-6 text-sm font-semibold">
            <a href="index.html" class="nav-link">Shop</a>
            <a href="fresh.html" class="text-[#3B7A57]">Fresh Mushrooms</a>
            <a href="wholesale.html" class="nav-link">Wholesale</a>
        </nav>

        <div class="relative">
            <button id="cart-toggle" class="relative p-2" aria-label="Cart">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-700" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span id="cart-badge"
                    class="absolute -top-1 -right-1 bg-green-600 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center hidden">0</span>
            </button>

            <div id="cart-dropdown" class="mt-2">
                <div class="p-4 border-b">
                    <h3 class="font-bold text-lg">Your Cart</h3>
                    <p id="mode-hint" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div id="cart-items" class="p-4 space-y-3"></div>
                <div id="cart-empty" class="p-8 text-center text-gray-500">Your cart is empty</div>

                <div class="p-4 border-t">
                    <div id="email-section" class="mb-4 hidden">
                        <label for="customer-email" class="block text-sm font-bold mb-2">Email (required for
                            subscriptions)</label>
                        <input id="customer-email" type="email" placeholder="you@example.com"
                            class="w-full rounded-xl border px-4 py-3" oninput="validateProceed()" />
                        <p id="email-error" class="text-red-500 text-sm mt-1 hidden">Please enter a valid email.</p>
                    </div>

                    <button id="proceed-btn" onclick="proceedToCheckout()" disabled
                        class="w-full text-white py-4 rounded-full font-bold text-lg transition">
                        Proceed to Checkout
                    </button>
                    <p id="checkout-status" class="text-sm mt-2 text-gray-500 text-center"></p>
                </div>
            </div>
        </div>

        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle Menu">
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
        </button>

        <div id="mobile-menu">
            <a href="index.html" class="font-bold py-2 border-b">Shop</a>
            <a href="fresh.html" class="font-bold py-2 border-b text-[#3B7A57]">Fresh Mushrooms</a>
            <a href="wholesale.html" class="font-bold py-2">Wholesale</a>
        </div>
    </header>

    <main class="flex-grow">
        <section class="page-section">
            <div class="max-w-6xl mx-auto text-center">
                <h1 class="text-4xl md:text-7xl font-bold mb-4 px-2">
                    <span class="text-fresh">Fresh</span>
                    <span class="text-gourmet">Gourmet</span><br class="md:hidden">
                    <span class="text-mushrooms">Mushrooms</span>
                </h1>
                <p class="text-gray-600 mb-12 max-w-2xl mx-auto px-6 text-sm md:text-base">
                    Harvested to order from our Adelaide farm. Add a subscription plan for savings, plus any extra
                    one-off boxes.
                </p>

                <h2 class="text-3xl font-bold mb-8">Subscription Plans</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16 text-left">
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-center border-b pb-2">Weekly</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                            <div class="plan-card">
                                <div class="font-bold text-base">1-Variety</div>
                                <div class="text-sm text-gray-500">(250g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$20/wk</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1SdSS9B03V57KY6P1w2mylJ5', '$20/wk – 1-Variety (250g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">2-Variety</div>
                                <div class="text-sm text-gray-500">(500g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$25/wk</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1SdSO7B03V57KY6P6OiZkgvF', '$25/wk – 2-Variety (500g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">3-Variety</div>
                                <div class="text-sm text-gray-500">(750g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$35/wk</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1SdSXkB03V57KY6PnfAUocFz', '$35/wk – 3-Variety (750g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">4-Variety</div>
                                <div class="text-sm text-gray-500">(1kg)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$45/wk</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3JZB03V57KY6PUl9AnG95', '$45/wk – 4-Variety (1kg)')">
                                    Add Plan
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-center border-b pb-2">Fortnightly</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                            <div class="plan-card">
                                <div class="font-bold text-base">1-Variety</div>
                                <div class="text-sm text-gray-500">(250g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$22/fn</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3awB03V57KY6PCX55FRHv', '$22/fn – 1-Variety (250g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">2-Variety</div>
                                <div class="text-sm text-gray-500">(500g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$27/fn</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3YxB03V57KY6PoNoaBiRn', '$27/fn – 2-Variety (500g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">3-Variety</div>
                                <div class="text-sm text-gray-500">(750g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$32/fn</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3edB03V57KY6PenA9ZByZ', '$32/fn – 3-Variety (750g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">4-Variety</div>
                                <div class="text-sm text-gray-500">(1kg)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$40/fn</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3VZB03V57KY6PxDUrEFNg', '$40/fn – 4-Variety (1kg)')">
                                    Add Plan
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-center border-b pb-2">Monthly</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                            <div class="plan-card">
                                <div class="font-bold text-base">1-Variety</div>
                                <div class="text-sm text-gray-500">(250g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$20/mo</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3rlB03V57KY6Pi9IJdF8y', '$20/mo – 1-Variety (250g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">2-Variety</div>
                                <div class="text-sm text-gray-500">(500g)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$32/mo</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3nTB03V57KY6Phuo34Ps2', '$32/mo – 2-Variety (500g)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">3-Variety</div>
                                <div class="text-sm text-gray-500">(1kg)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$40/mo</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3llB03V57KY6PuHfwaxuQ', '$40/mo – 3-Variety (1kg)')">
                                    Add Plan
                                </button>
                            </div>
                            <div class="plan-card">
                                <div class="font-bold text-base">4-Variety</div>
                                <div class="text-sm text-gray-500">(1.5kg)</div>
                                <div class="mt-2 font-bold text-green-700 text-2xl">$55/mo</div>
                                <button type="button" class="add-plan-btn"
                                    onclick="addPlanToCart(this, 'price_1Sj3jYB03V57KY6PwCVObZmX', '$55/mo – 4-Variety (1.5kg)')">
                                    Add Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 class="text-3xl font-bold mb-8">Add Extra One-Off Boxes</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 px-2 mb-12 text-left">
                    <div class="product-card" id="card-oyster">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/blue-grey-oyster-mushroom-grain-spawn-kit.webp"
                            class="h-48 w-full object-cover" alt="Oyster Mix">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Oyster Mix (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Blue, Grey, or White. Meaty and smoky umami.
                            </p>
                            <p class="text-fresh font-bold text-xl mb-4">$20.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('oyster', -1, event)">-</button>
                                <input id="qty-oyster" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('oyster', 1, event)">+</button>
                            </div>
                            <button id="addbtn-oyster"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('oyster')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>

                    <div class="product-card" id="card-shiitake">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/shiitake_grow_block_2.jpg"
                            class="h-48 w-full object-cover" alt="Fresh Shiitake">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Fresh Shiitake (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Earthy, meaty, and slightly smoky with a
                                savory umami depth.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$25.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('shiitake', -1, event)">-</button>
                                <input id="qty-shiitake" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('shiitake', 1, event)">+</button>
                            </div>
                            <button id="addbtn-shiitake"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('shiitake')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>

                    <div class="product-card" id="card-lions">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/lions_mane_pride.webp"
                            class="h-48 w-full object-cover" alt="Lion's Mane">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Lion's Mane (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Delicate seafood sweetness with a
                                lobster-mimicking texture.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$25.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('lions', -1, event)">-</button>
                                <input id="qty-lions" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('lions', 1, event)">+</button>
                            </div>
                            <button id="addbtn-lions"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('lions')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>

                    <div class="product-card" id="card-maitake">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/Maitake+mushroom.webp"
                            class="h-48 w-full object-cover" alt="Maitake">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Maitake (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Bold, nutty earthiness with a rich, hearty
                                chew.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$35.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('maitake', -1, event)">-</button>
                                <input id="qty-maitake" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('maitake', 1, event)">+</button>
                            </div>
                            <button id="addbtn-maitake"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('maitake')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>

                    <div class="product-card" id="card-bundle3">
                        <div
                            class="h-48 bg-gray-100 flex items-center justify-center font-bold text-gray-400 uppercase text-center p-4">
                            3-Variety Box
                        </div>
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">3-Variety Bundle (750g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">A symphony of sweet, smoky, and buttery
                                flavors.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$45.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('bundle3', -1, event)">-</button>
                                <input id="qty-bundle3" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('bundle3', 1, event)">+</button>
                            </div>
                            <button id="addbtn-bundle3"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('bundle3')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>

                    <div class="product-card" id="card-bundle4">
                        <div
                            class="h-48 bg-gray-100 flex items-center justify-center font-bold text-gray-400 uppercase text-center p-4">
                            4-Variety Box
                        </div>
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">4-Variety Bundle (1kg)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">The ultimate balance of all our gourmet
                                varieties.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$55.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateOneOffQty('bundle4', -1, event)">-</button>
                                <input id="qty-bundle4" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateOneOffQty('bundle4', 1, event)">+</button>
                            </div>
                            <button id="addbtn-bundle4"
                                class="mt-4 bg-green-600 text-white py-3 rounded-lg font-bold disabled:opacity-50"
                                onclick="addOneOffToCart('bundle4')" disabled>
                                Select quantity
                            </button>
                        </div>
                    </div>
                </div>

                <p class="text-xs text-gray-500 max-w-3xl mx-auto px-6">
                    Tip: Add a subscription plan for ongoing deliveries, then add any extra one-off boxes you want in
                    the same checkout.
                </p>
            </div>
        </section>
    </main>

    <footer class="text-center p-8 text-gray-400 text-sm">© 2026 Dura Fungi. All rights reserved.</footer>

    <div id="toast">Added</div>

    <script>
        function toggleMenu() {
            document.getElementById('mobile-menu').classList.toggle('open');
        }

        const API = "https://api.durafungi.com/create-checkout-session";

        const CART_KEY = "durafungi_cart_v2";

        function getCart() {
            try {
                const raw = localStorage.getItem(CART_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                localStorage.removeItem(CART_KEY);
                return [];
            }
        }

        function setCart(cart) {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
            updateCartUI();
        }

        function cartCount() {
            return getCart().reduce((sum, it) => sum + (parseInt(it.quantity, 10) || 0), 0);
        }

        function hasRecurring() {
            return getCart().some(it => !!it.recurring);
        }

        function addToCart(item) {
            const price = String(item.price || "").trim();
            const label = String(item.label || "").trim();
            const recurring = !!item.recurring;
            const q = Math.max(1, parseInt(item.quantity, 10) || 1);

            if (!price) return;

            let cart = getCart();

            if (recurring) {
                cart = cart.filter(it => !it.recurring);
            }

            const existing = cart.find(it => it.price === price);
            if (existing) existing.quantity = (parseInt(existing.quantity, 10) || 0) + q;
            else cart.push({ price: price, quantity: q, recurring: recurring, label: label });

            setCart(cart);
        }

        function removeFromCart(price) {
            const cart = getCart().filter(it => it.price !== price);
            setCart(cart);
            syncPlanUIFromCart();
        }

        function cartToLineItems() {
            return getCart()
                .map(it => ({ price: it.price, quantity: Math.max(1, parseInt(it.quantity, 10) || 1) }))
                .filter(x => x.price && x.quantity > 0);
        }

        function isValidEmail(email) {
            return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(email || "").trim());
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = msg || "Added";
            t.classList.add('show');
            window.clearTimeout(window.__dfToastTimer);
            window.__dfToastTimer = window.setTimeout(() => t.classList.remove('show'), 1400);
        }

        function flashCard(cardId) {
            const el = document.getElementById(cardId);
            if (!el) return;
            el.classList.add('flash');
            window.setTimeout(() => el.classList.remove('flash'), 180);
        }

        function addPlanToCart(btn, priceId, label) {
            const buttons = document.querySelectorAll('.add-plan-btn');
            buttons.forEach(b => {
                b.textContent = "Add Plan";
                b.classList.remove('added');
                b.disabled = false;
            });

            btn.disabled = true;
            btn.textContent = "Adding…";

            addToCart({ price: priceId, quantity: 1, recurring: true, label: label });

            btn.textContent = "Plan Added ✓";
            btn.classList.add('added');
            btn.disabled = false;

            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('added'));
            const card = btn.closest('.plan-card');
            if (card) card.classList.add('added');

            toast("Subscription plan added");
        }

        const oneOffCatalog = {
            oyster: { price: 'price_1Si7xMB03V57KY6PGoBS1kWm', label: 'Oyster Mix (250g) – $20' },
            shiitake: { price: 'price_1SdTYlB03V57KY6Pv6knoTkV', label: 'Fresh Shiitake (250g) – $25' },
            lions: { price: 'price_1SdTV0B03V57KY6PKtiPgCdf', label: "Lion's Mane (250g) – $25" },
            maitake: { price: 'price_1SdTaMB03V57KY6Pqj4zPCi9', label: 'Maitake (250g) – $35' },
            bundle3: { price: 'price_1Sj3D4B03V57KY6PiBgibOnK', label: '3-Variety Bundle (750g) – $45' },
            bundle4: { price: 'price_1Sj3EjB03V57KY6PVeCPdl0P', label: '4-Variety Bundle (1kg) – $55' }
        };

        function updateOneOffQty(key, delta, event) {
            if (event) event.stopPropagation();

            const input = document.getElementById(`qty-${key}`);
            if (!input) return;

            let qty = parseInt(input.value, 10) || 0;
            qty = Math.max(0, qty + (parseInt(delta, 10) || 0));
            input.value = String(qty);

            const card = document.getElementById(`card-${key}`);
            if (card) card.classList.toggle('has-items', qty > 0);

            const addBtn = document.getElementById(`addbtn-${key}`);
            if (addBtn) {
                addBtn.disabled = (qty === 0);
                addBtn.textContent = (qty === 0) ? "Select quantity" : "Add to Cart";
            }
        }

        function addOneOffToCart(key) {
            const item = oneOffCatalog[key];
            if (!item) return;

            const qtyInput = document.getElementById(`qty-${key}`);
            const qty = qtyInput ? (parseInt(qtyInput.value, 10) || 0) : 0;
            if (qty <= 0) return;

            const btn = document.getElementById(`addbtn-${key}`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = "Adding…";
            }

            addToCart({ price: item.price, quantity: qty, recurring: false, label: item.label });

            if (qtyInput) qtyInput.value = "0";
            updateOneOffQty(key, 0);

            if (btn) {
                btn.textContent = "Added ✓";
                window.setTimeout(() => {
                    btn.textContent = "Select quantity";
                    btn.disabled = true;
                }, 900);
            }

            flashCard(`card-${key}`);
            toast("Added to cart");
        }

        function validateProceed() {
            const proceedBtn = document.getElementById('proceed-btn');
            const emailSection = document.getElementById('email-section');
            const emailEl = document.getElementById('customer-email');
            const emailError = document.getElementById('email-error');

            const cart = getCart();
            const hasItems = cart.length > 0;
            const needsEmail = hasRecurring();

            if (emailSection) emailSection.classList.toggle('hidden', !needsEmail);

            if (!hasItems) {
                if (proceedBtn) proceedBtn.disabled = true;
                if (emailError) emailError.classList.add('hidden');
                return;
            }

            if (!needsEmail) {
                if (proceedBtn) proceedBtn.disabled = false;
                if (emailError) emailError.classList.add('hidden');
                return;
            }

            const email = emailEl ? emailEl.value.trim() : "";
            const ok = isValidEmail(email);

            if (emailError) emailError.classList.toggle('hidden', ok);
            if (proceedBtn) proceedBtn.disabled = !ok;
        }

        function syncPlanUIFromCart() {
            const cart = getCart();
            const plan = cart.find(it => it.recurring);

            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('added'));
            document.querySelectorAll('.add-plan-btn').forEach(b => {
                b.textContent = "Add Plan";
                b.classList.remove('added');
            });

            if (!plan) return;

            const buttons = document.querySelectorAll('.add-plan-btn');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute("onclick") || "";
                if (onclick.indexOf(plan.price) !== -1) {
                    btn.textContent = "Plan Added ✓";
                    btn.classList.add('added');
                    const card = btn.closest('.plan-card');
                    if (card) card.classList.add('added');
                }
            });
        }

        function updateCartUI() {
            const cart = getCart();
            const badge = document.getElementById('cart-badge');
            const count = cartCount();

            if (badge) {
                badge.textContent = String(count);
                badge.classList.toggle('hidden', count === 0);
            }

            const itemsContainer = document.getElementById('cart-items');
            const emptyMsg = document.getElementById('cart-empty');
            const modeHint = document.getElementById('mode-hint');

            if (!itemsContainer || !emptyMsg) return;

            if (cart.length === 0) {
                itemsContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                if (modeHint) modeHint.textContent = "";
                validateProceed();
                return;
            }

            emptyMsg.classList.add('hidden');

            itemsContainer.innerHTML = cart.map(it => {
                const safeLabel = (it.label || "Item").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const qty = Math.max(1, parseInt(it.quantity, 10) || 1);
                const tag = it.recurring ? '<span class="text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded-full ml-2">SUBSCRIPTION</span>' : '';
                return `
                    <div class="flex justify-between items-start border-b pb-3">
                        <div class="pr-3">
                            <div class="font-medium">${safeLabel}${tag}</div>
                            <div class="text-sm text-gray-600">Qty: ${qty}</div>
                        </div>
                        <button onclick="removeFromCart('${it.price}')" class="text-red-600 text-sm font-bold">Remove</button>
                    </div>
                `;
            }).join('');

            if (modeHint) {
                if (hasRecurring()) {
                    modeHint.textContent = "Checkout mode: Subscription";
                    modeHint.innerHTML = modeHint.textContent + '<span class="block mt-1 text-xs text-gray-500">First payment shown at checkout (recurring).</span>';
                } else {
                    modeHint.textContent = "Checkout mode: One-off payment";
                }
            }

            validateProceed();
        }

        function openCart() {
            const dd = document.getElementById('cart-dropdown');
            if (dd) dd.classList.add('open');
        }

        function closeCart() {
            const dd = document.getElementById('cart-dropdown');
            if (dd) dd.classList.remove('open');
        }

        document.getElementById('cart-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            const dd = document.getElementById('cart-dropdown');
            if (!dd) return;
            dd.classList.toggle('open');
        });

        document.addEventListener('click', () => closeCart());

        const ddEl = document.getElementById('cart-dropdown');
        if (ddEl) ddEl.addEventListener('click', (e) => e.stopPropagation());

        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") closeCart();
        });

        async function proceedToCheckout() {
            const btn = document.getElementById('proceed-btn');
            const status = document.getElementById('checkout-status');
            const emailEl = document.getElementById('customer-email');

            const items = cartToLineItems();
            if (items.length === 0) return;

            const needsEmail = hasRecurring();
            const email = emailEl ? emailEl.value.trim() : "";

            if (needsEmail && !isValidEmail(email)) {
                const emailError = document.getElementById('email-error');
                if (emailError) emailError.classList.remove('hidden');
                return;
            }

            try {
                if (btn) {
                    btn.disabled = true;
                    btn.dataset.dfOriginalText = btn.textContent;
                    btn.textContent = "Redirecting…";
                }
                if (status) status.textContent = "Redirecting to secure checkout...";

                const payload = {
                    items: items,
                    returnUrl: window.location.href
                };

                if (needsEmail) payload.customerEmail = email;

                const res = await fetch(API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok) throw new Error(data.error || data.message || ("Server error: " + res.status));
                if (!data.url) throw new Error("No checkout URL returned from server.");

                window.location.href = data.url;
            } catch (err) {
                alert("Checkout error: " + (err.message || "Unknown error"));

                if (btn) {
                    btn.disabled = false;
                    btn.textContent = btn.dataset.dfOriginalText || "Proceed to Checkout";
                }
                if (status) status.textContent = "";
                validateProceed();
            }
        }

        function initOneOffButtons() {
            Object.keys(oneOffCatalog).forEach(k => updateOneOffQty(k, 0));
        }

        syncPlanUIFromCart();
        initOneOffButtons();
        updateCartUI();
    </script>

    <!-- Cart initialization guard -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.__DF_CART_BOOTED) return;
            window.__DF_CART_BOOTED = true;
            window.DF_CART.init();
        });
    </script>
</body>

</html>