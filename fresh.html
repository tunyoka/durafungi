<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Fresh Mushrooms – DuraFungi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'Montserrat';
            src: url('/assets/fonts/MontserratVariableFontwght.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --black: #1F1F1F;
            --white: #F5F5F5;
            --beige: #D8C3A5;
            --green: #3B7A57;
            --rust: #8B5E3C;
            --silver: #C0C0C0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #ffffff;
            color: var(--black);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .text-fresh {
            color: var(--green);
        }

        .text-gourmet {
            color: var(--rust);
        }

        .text-mushrooms {
            color: var(--black);
        }

        header {
            background: linear-gradient(to bottom, var(--beige) 0%, #fff 100%);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* MOBILE MENU LOGIC */
        .nav-toggle {
            display: block;
            cursor: pointer;
            padding: 0.5rem;
        }

        .nav-toggle-line {
            width: 24px;
            height: 2px;
            background: var(--black);
            margin: 5px 0;
        }

        #mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        #mobile-menu.open {
            display: flex;
        }

        @media (min-width: 768px) {
            .nav-toggle {
                display: none;
            }

            #mobile-menu {
                display: none !important;
            }
        }

        .nav-link:hover {
            color: var(--green);
        }

        .page-section {
            padding: 2rem 1.25rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.85rem 0.5rem;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            border: 2px solid var(--silver);
            background: #fff;
            color: var(--black);
        }

        @media (min-width: 640px) {
            .mode-btn {
                font-size: 1rem;
                padding: 0.75rem 2.5rem;
                flex: none;
            }
        }

        .mode-btn.active {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        .product-card {
            background: #fff;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .product-card.has-items {
            border-color: var(--green);
            background-color: #f0fdf4;
        }

        .plan-card {
            background: #fff;
            border: 2px solid #e5e7eb;
            padding: 1rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: 0.2s;
            -webkit-tap-highlight-color: transparent;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 160px;
            /* Ensures consistent height on mobile */
        }

        .plan-card.active {
            border-color: var(--green);
            background-color: #f0fdf4;
        }

        .plan-select-btn {
            margin-top: 1rem;
            background-color: var(--green);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }

        .plan-select-btn:hover {
            background-color: #2d6046;
        }

        .plan-card.active .plan-select-btn {
            background-color: white;
            color: var(--green);
            border: 2px solid var(--green);
        }

        .qty-input {
            width: 44px;
            text-align: center;
            font-weight: bold;
            font-size: 1.25rem;
            background: transparent;
            border: none;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #f3f4f6;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.25rem;
            touch-action: manipulation;
        }

        #checkout-btn {
            background-color: #9ca3af;
            width: 100%;
            max-width: 400px;
        }

        #checkout-btn:not(:disabled) {
            background-color: var(--green);
        }

        .hidden {
            display: none;
        }

        /* Mobile-specific improvements */
        @media (max-width: 767px) {
            .page-section {
                padding: 1.5rem 1rem;
            }

            .mode-btn {
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
            }

            .plan-card {
                padding: 1.25rem 1rem;
                min-height: 180px;
            }

            .plan-select-btn {
                padding: 0.875rem 1rem;
                font-size: 1rem;
            }

            #email-wrapper {
                margin-top: 2rem;
                padding: 0 0.5rem;
            }

            .mt-12 {
                margin-top: 2.5rem !important;
            }

            #total-display {
                font-size: 1.5rem;
            }

            #checkout-btn {
                padding: 1.25rem;
                font-size: 1.125rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <a href="index.html">
            <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/logo.png" alt="Dura Fungi"
                class="h-10 md:h-12" />
        </a>

        <nav class="hidden md:flex gap-6 text-sm font-semibold">
            <a href="index.html" class="nav-link">Shop</a>
            <a href="fresh.html" class="text-[#3B7A57]">Fresh Mushrooms</a>
            <a href="wholesale.html" class="nav-link">Wholesale</a>
        </nav>

        <button class="nav-toggle" onclick="toggleMenu()" aria-label="Toggle Menu">
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
        </button>

        <div id="mobile-menu">
            <a href="index.html" class="font-bold py-2 border-b">Shop</a>
            <a href="fresh.html" class="font-bold py-2 border-b text-[#3B7A57]">Fresh Mushrooms</a>
            <a href="wholesale.html" class="font-bold py-2">Wholesale</a>
        </div>
    </header>

    <main class="flex-grow">
        <section class="page-section">
            <div class="max-w-6xl mx-auto text-center">
                <h1 class="text-4xl md:text-7xl font-bold mb-4 px-2">
                    <span class="text-fresh">Fresh</span>
                    <span class="text-gourmet">Gourmet</span><br class="md:hidden">
                    <span class="text-mushrooms">Mushrooms</span>
                </h1>
                <p class="text-gray-600 mb-8 max-w-2xl mx-auto px-6 text-sm md:text-base">
                    Harvested to order from our Adelaide farm. Choose subscription for savings or build your own one-off
                    box.
                </p>

                <div class="flex justify-center gap-2 md:gap-4 mb-10 px-4">
                    <button type="button" id="btn-sub" class="mode-btn active"
                        onclick="toggleMode('subscription')">Subscribe & Save</button>
                    <button type="button" id="btn-oneoff" class="mode-btn" onclick="toggleMode('one-off')">One-Off
                        Purchase</button>
                </div>

                <div id="section-subscription" class="space-y-12 px-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-left">
                        <div class="space-y-4">
                            <h2 class="text-xl font-bold border-b pb-2 text-center">Weekly</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1SdSS9B03V57KY6P1w2mylJ5', '$20.00/wk')">
                                    <div class="font-bold text-base">1-Variety</div>
                                    <div class="text-sm text-gray-500">(250g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$20/wk</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1SdSS9B03V57KY6P1w2mylJ5', '$20.00/wk')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1SdSO7B03V57KY6P6OiZkgvF', '$25.00/wk')">
                                    <div class="font-bold text-base">2-Variety</div>
                                    <div class="text-sm text-gray-500">(500g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$25/wk</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1SdSO7B03V57KY6P6OiZkgvF', '$25.00/wk')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1SdSXkB03V57KY6PnfAUocFz', '$35.00/wk')">
                                    <div class="font-bold text-base">3-Variety</div>
                                    <div class="text-sm text-gray-500">(750g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$35/wk</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1SdSXkB03V57KY6PnfAUocFz', '$35.00/wk')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3JZB03V57KY6PUl9AnG95', '$45.00/wk')">
                                    <div class="font-bold text-base">4-Variety</div>
                                    <div class="text-sm text-gray-500">(1kg)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$45/wk</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3JZB03V57KY6PUl9AnG95', '$45.00/wk')">
                                        Choose Plan
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h2 class="text-xl font-bold border-b pb-2 text-center">Fortnightly</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3awB03V57KY6PCX55FRHv', '$22.00/fn')">
                                    <div class="font-bold text-base">1-Variety</div>
                                    <div class="text-sm text-gray-500">(250g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$22/fn</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3awB03V57KY6PCX55FRHv', '$22.00/fn')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3YxB03V57KY6PoNoaBiRn', '$27.00/fn')">
                                    <div class="font-bold text-base">2-Variety</div>
                                    <div class="text-sm text-gray-500">(500g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$27/fn</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3YxB03V57KY6PoNoaBiRn', '$27.00/fn')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3edB03V57KY6PenA9ZByZ', '$32.00/fn')">
                                    <div class="font-bold text-base">3-Variety</div>
                                    <div class="text-sm text-gray-500">(750g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$32/fn</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3edB03V57KY6PenA9ZByZ', '$32.00/fn')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3VZB03V57KY6PxDUrEFNg', '$40.00/fn')">
                                    <div class="font-bold text-base">4-Variety</div>
                                    <div class="text-sm text-gray-500">(1kg)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$40/fn</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3VZB03V57KY6PxDUrEFNg', '$40.00/fn')">
                                        Choose Plan
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h2 class="text-xl font-bold border-b pb-2 text-center">Monthly</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-1 gap-4">
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3rlB03V57KY6Pi9IJdF8y', '$20.00/mo')">
                                    <div class="font-bold text-base">1-Variety</div>
                                    <div class="text-sm text-gray-500">(250g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$20/mo</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3rlB03V57KY6Pi9IJdF8y', '$20.00/mo')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3nTB03V57KY6Phuo34Ps2', '$32.00/mo')">
                                    <div class="font-bold text-base">2-Variety</div>
                                    <div class="text-sm text-gray-500">(500g)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$32/mo</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3nTB03V57KY6Phuo34Ps2', '$32.00/mo')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3llB03V57KY6PuHfwaxuQ', '$40.00/mo')">
                                    <div class="font-bold text-base">3-Variety</div>
                                    <div class="text-sm text-gray-500">(1kg)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$40/mo</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3llB03V57KY6PuHfwaxuQ', '$40.00/mo')">
                                        Choose Plan
                                    </button>
                                </div>
                                <div class="plan-card"
                                    onclick="selectPlan(this, 'price_1Sj3jYB03V57KY6PwCVObZmX', '$55.00/mo')">
                                    <div class="font-bold text-base">4-Variety</div>
                                    <div class="text-sm text-gray-500">(1.5kg)</div>
                                    <div class="mt-2 font-bold text-green-700 text-lg">$55/mo</div>
                                    <button type="button" class="plan-select-btn"
                                        onclick="event.stopPropagation(); selectPlan(this.closest('.plan-card'), 'price_1Sj3jYB03V57KY6PwCVObZmX', '$55.00/mo')">
                                        Choose Plan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email field moved below plan grid for subscription mode -->
                    <div id="email-wrapper" class="max-w-md mx-auto mt-12 px-4 text-left">
                        <label for="email" class="block text-sm font-bold mb-2 ml-1">Your email (required for all
                            orders)</label>
                        <input id="email" type="email" placeholder="you@example.com" oninput="validateCheckout()"
                            class="w-full rounded-2xl border border-gray-300 px-4 py-4 outline-none focus:ring-2 focus:ring-[#3B7A57] text-lg shadow-sm" />
                        <p class="text-xs text-gray-600 mt-2 ml-1">We'll use this to create your account and send order
                            updates.</p>
                        <p id="email-error" class="text-red-500 text-sm mt-2 hidden ml-1">Please enter a valid email.
                        </p>
                    </div>
                </div>

                <div id="section-oneoff" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 px-2">
                    <div class="product-card" id="card-oyster">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/blue-grey-oyster-mushroom-grain-spawn-kit.webp"
                            class="h-48 w-full object-cover">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Oyster Mix (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Blue, Grey, or White. Meaty and smoky umami.
                            </p>
                            <p class="text-fresh font-bold text-xl mb-4">$20.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('oyster', -1, event)">-</button>
                                <input id="qty-oyster" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('oyster', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-shiitake">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/shiitake_grow_block_2.jpg"
                            class="h-48 w-full object-cover">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Fresh Shiitake (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Earthy, meaty, and slightly smoky with a
                                savory umami depth.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$25.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('shiitake', -1, event)">-</button>
                                <input id="qty-shiitake" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('shiitake', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-lions">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/lions_mane_pride.webp"
                            class="h-48 w-full object-cover">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Lion's Mane (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Delicate seafood sweetness with a
                                lobster-mimicking texture.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$25.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('lions', -1, event)">-</button>
                                <input id="qty-lions" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('lions', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-maitake">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/Maitake+mushroom.webp"
                            class="h-48 w-full object-cover">
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">Maitake (250g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">Bold, nutty earthiness with a rich, hearty
                                chew.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$35.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('maitake', -1, event)">-</button>
                                <input id="qty-maitake" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('maitake', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-bundle3">
                        <div
                            class="h-48 bg-gray-100 flex items-center justify-center font-bold text-gray-400 uppercase text-center p-4">
                            3-Variety Box</div>
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">3-Variety Bundle (750g)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">A symphony of sweet, smoky, and buttery
                                flavors.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$45.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('bundle3', -1, event)">-</button>
                                <input id="qty-bundle3" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('bundle3', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-bundle4">
                        <div
                            class="h-48 bg-gray-100 flex items-center justify-center font-bold text-gray-400 uppercase text-center p-4">
                            4-Variety Box</div>
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="font-bold text-lg">4-Variety Bundle (1kg)</h3>
                            <p class="text-sm text-gray-600 mb-4 flex-grow">The ultimate balance of all our gourmet
                                varieties.</p>
                            <p class="text-fresh font-bold text-xl mb-4">$55.00</p>
                            <div class="flex justify-center items-center gap-6">
                                <button class="qty-btn" onclick="updateQty('bundle4', -1, event)">-</button>
                                <input id="qty-bundle4" class="qty-input" value="0" readonly />
                                <button class="qty-btn" onclick="updateQty('bundle4', 1, event)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 bg-gray-50 p-8 rounded-3xl inline-block w-full md:w-auto shadow-inner">
                    <p id="total-display" class="text-2xl font-bold mb-6" aria-live="polite">Select a plan to continue
                    </p>
                    <button id="checkout-btn" onclick="checkout()" disabled
                        class="text-white px-12 py-5 rounded-full font-bold transition shadow-md text-lg">Secure
                        Checkout</button>
                    <p id="checkout-status" class="text-sm mt-4 text-gray-500 font-medium h-4"></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center p-8 text-gray-400 text-sm">© 2025 Dura Fungi. All rights reserved.</footer>

    <script>
        function toggleMenu() {
            document.getElementById('mobile-menu').classList.toggle('open');
        }

        let currentMode = 'subscription';
        let selectedSubId = null;
        let selectedSubLabel = "";

        const catalog = {
            oyster: { id: 'price_1Si7xMB03V57KY6PGoBS1kWm', price: 20, qty: 0 },
            shiitake: { id: 'price_1SdTYlB03V57KY6Pv6knoTkV', price: 25, qty: 0 },
            lions: { id: 'price_1SdTV0B03V57KY6PKtiPgCdf', price: 25, qty: 0 },
            maitake: { id: 'price_1SdTaMB03V57KY6Pqj4zPCi9', price: 35, qty: 0 },
            bundle3: { id: 'price_1Sj3D4B03V57KY6PiBgibOnK', price: 45, qty: 0 },
            bundle4: { id: 'price_1Sj3EjB03V57KY6PVeCPdl0P', price: 55, qty: 0 }
        };

        function toggleMode(mode) {
            currentMode = mode;
            document.getElementById('btn-sub').classList.toggle('active', mode === 'subscription');
            document.getElementById('btn-oneoff').classList.toggle('active', mode === 'one-off');
            document.getElementById('section-subscription').classList.toggle('hidden', mode !== 'subscription');
            document.getElementById('section-oneoff').classList.toggle('hidden', mode !== 'one-off');
            document.getElementById('email-wrapper').classList.toggle('hidden', mode === 'one-off');
            document.getElementById('checkout-status').innerText = "";

            if (mode === 'subscription') {
                document.getElementById('total-display').innerText = selectedSubId ? `Plan Selected: ${selectedSubLabel}` : "Select a plan to continue";
            } else {
                calculateTotal();
            }
            validateCheckout();
        }

        function selectPlan(el, id, label) {
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedSubId = id;
            selectedSubLabel = label;
            document.getElementById('total-display').innerText = `Plan Selected: ${label}`;
            validateCheckout();
        }

        function updateQty(key, delta, event) {
            if (event) event.stopPropagation();
            catalog[key].qty = Math.max(0, catalog[key].qty + delta);
            const qtyEl = document.getElementById(`qty-${key}`);
            const cardEl = document.getElementById(`card-${key}`);
            if (qtyEl) qtyEl.value = catalog[key].qty;
            if (cardEl) cardEl.classList.toggle('has-items', catalog[key].qty > 0);
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            for (let k in catalog) total += catalog[k].qty * catalog[k].price;
            if (currentMode === 'one-off') {
                document.getElementById('total-display').innerText = total > 0 ? `Total: $${total.toFixed(2)}` : "Total: $0.00";
            }
            validateCheckout();
        }

        const CART_KEY = "durafungi_cart_v1";

        function getCart() {
            try { return JSON.parse(localStorage.getItem(CART_KEY) || "{}"); }
            catch { return {}; }
        }

        function setCart(cart) {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
        }

        function validateCheckout() {
            const btn = document.getElementById('checkout-btn');
            const email = document.getElementById('email').value.trim();
            const emailError = document.getElementById('email-error');
            const isEmailValid = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);

            let canCheckout = false;
            if (currentMode === 'subscription') {
                canCheckout = !!selectedSubId && isEmailValid;
                if (selectedSubId && !isEmailValid) emailError.classList.remove('hidden');
                else emailError.classList.add('hidden');
            } else {
                let totalQty = 0;
                for (let k in catalog) totalQty += catalog[k].qty;
                canCheckout = totalQty > 0;
                emailError.classList.add('hidden');
            }
            btn.disabled = !canCheckout;
        }

        async function checkout() {
            const emailInput = document.getElementById('email');
            const btn = document.getElementById('checkout-btn');
            const status = document.getElementById('checkout-status');
            const email = emailInput.value.trim();
            const isEmailValid = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);

            let items = [];
            if (currentMode === 'subscription') {
                items.push({ price: selectedSubId, quantity: 1 });
            } else {
                for (let k in catalog) {
                    if (catalog[k].qty > 0) items.push({ price: catalog[k].id, quantity: catalog[k].qty });
                }
            }

            try {
                btn.disabled = true;
                status.innerText = "Redirecting to secure checkout...";

                const response = await fetch("https://api.durafungi.com/create-checkout-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        checkoutMode: currentMode === 'subscription' ? 'subscription' : 'payment',
                        items: items,
                        ...(isEmailValid ? { customerEmail: email } : {})
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Server error (${response.status}): ${text}`);
                }

                const data = await response.json();
                if (data.url) window.location.href = data.url;
                else throw new Error(data.error || "Session generation failed.");
            } catch (err) {
                alert("Checkout Error: " + err.message);
                btn.disabled = false;
                status.innerText = "";
                validateCheckout();
            }
        }
    </script>
</body>

</html>