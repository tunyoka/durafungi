<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>Gourmet Grow Blocks – DuraFungi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'Montserrat';
            src: url('/assets/fonts/MontserratVariableFontwght.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --black: #1F1F1F;
            --white: #F5F5F5;
            --beige: #D8C3A5;
            --green: #3B7A57;
            --rust: #8B5E3C;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #ffffff;
            color: var(--black);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(to bottom, var(--beige) 0%, #fff 100%);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-toggle {
            display: block;
            cursor: pointer;
            padding: 0.5rem;
        }

        .nav-toggle-line {
            width: 24px;
            height: 2px;
            background: var(--black);
            margin: 5px 0;
        }

        #mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        #mobile-menu.open {
            display: flex;
        }

        @media (min-width: 768px) {
            .nav-toggle {
                display: none;
            }

            #mobile-menu {
                display: none !important;
            }
        }

        .product-card {
            background: #fff;
            border: 2px solid #f3f4f6;
            transition: all 0.3s ease;
            border-radius: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .product-card.has-items {
            border-color: var(--green);
            background-color: #f0fdf4;
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .save-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--rust);
            color: white;
            font-size: 11px;
            font-weight: 800;
            padding: 4px 12px;
            border-bottom-left-radius: 12px;
            display: none;
            /* Shown only in subscription mode */
        }

        .mode-subscription .save-badge {
            display: block;
        }

        .qty-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            font-weight: bold;
            border: none;
            background: transparent;
        }

        .mode-btn {
            padding: 0.85rem 1.5rem;
            font-weight: 700;
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
            background: white;
        }

        .mode-btn.active {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }

        #sticky-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--black);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 90;
        }

        #sticky-bar.visible {
            transform: translateY(0);
        }
    </style>
</head>

<body class="mode-payment" id="body-wrapper">
    <header>
        <a href="index.html">
            <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/logo.png" alt="Dura Fungi"
                class="h-10 md:h-12" />
        </a>
        <nav class="hidden md:flex gap-6 text-sm font-semibold">
            <a href="index.html" class="hover:text-[#3B7A57]">Shop</a>
            <a href="fresh.html" class="hover:text-[#3B7A57]">Fresh Mushrooms</a>
            <a href="grow-blocks.html" class="text-[#3B7A57]">Grow Blocks</a>
            <a href="wholesale.html" class="hover:text-[#3B7A57]">Wholesale</a>
        </nav>
        <button class="nav-toggle" onclick="toggleMenu()">
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
            <div class="nav-toggle-line"></div>
        </button>
        <div id="mobile-menu">
            <a href="index.html" class="font-bold py-2 border-b">Shop</a>
            <a href="fresh.html" class="font-bold py-2 border-b">Fresh Mushrooms</a>
            <a href="grow-blocks.html" class="font-bold py-2 border-b text-[#3B7A57]">Grow Blocks</a>
            <a href="wholesale.html" class="font-bold py-2">Wholesale</a>
        </div>
    </header>

    <main class="flex-grow pb-32">
        <section class="max-w-6xl mx-auto px-6 py-12">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold mb-4">Mushroom <span class="text-[#3B7A57]">Grow Blocks</span>
                </h1>
                <p class="text-gray-600 max-w-2xl mx-auto">Ready-to-fruit 3kg gourmet blocks. Harvest $120–$180 worth of
                    fresh mushrooms at home. Grown in Adelaide, shipped Australia-wide.</p>

                <div class="flex justify-center mt-8">
                    <div class="inline-flex rounded-full overflow-hidden border-2 border-gray-100 p-1 bg-gray-50">
                        <button id="mode-payment" class="mode-btn active rounded-full px-8"
                            onclick="setMode('payment')">One-Time</button>
                        <button id="mode-subscription" class="mode-btn rounded-full px-8"
                            onclick="setMode('subscription')">Subscribe & Save 20%</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="product-card" id="card-blue-oyster">
                    <div class="save-badge">SAVE 20%</div>
                    <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/blue-grey-oyster-mushroom-grain-spawn-kit.webp"
                        class="h-56 w-full object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-xl">Blue-Grey Oyster</h3>
                            <span
                                class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 uppercase">3KG
                                Block</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Yields 750g–1.5kg ($120 Value). High producer, perfect for
                            beginners.</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-[#3B7A57] price-display"
                                data-id="blue-oyster">$55.00</span>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('blue-oyster', -1)">-</button>
                                <input id="qty-blue-oyster" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('blue-oyster', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="product-card" id="card-lions-mane">
                    <div class="save-badge">SAVE 20%</div>
                    <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/lion's_mane_mushroom_growing_kit.webp"
                        class="h-56 w-full object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-xl">Lion's Mane</h3>
                            <span
                                class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 uppercase">3KG
                                Block</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Yields 600g–1.2kg ($150 Value). Gourmet favorite with
                            lobster-like texture.</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-[#3B7A57] price-display"
                                data-id="lions-mane">$55.00</span>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('lions-mane', -1)">-</button>
                                <input id="qty-lions-mane" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('lions-mane', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="product-card" id="card-shiitake">
                    <div class="save-badge">SAVE 20%</div>
                    <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/shiitake_guide.webp"
                        class="h-56 w-full object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-xl">Shiitake Block</h3>
                            <span
                                class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 uppercase">3KG
                                Block</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Yields 800g–1.4kg ($140 Value). The umami king. Meaty
                            texture, beautiful aroma.</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-[#3B7A57] price-display"
                                data-id="shiitake">$60.00</span>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('shiitake', -1)">-</button>
                                <input id="qty-shiitake" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('shiitake', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="product-card" id="card-maitake">
                    <div class="save-badge">SAVE 20%</div>
                    <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/Maitake+mushroom.webp"
                        class="h-56 w-full object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-xl">Maitake Block</h3>
                            <span
                                class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 uppercase">3KG
                                Block</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">Yields 500g–1kg ($180 Value). Hen of the Woods. Rare,
                            earthy, and nutty.</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-[#3B7A57] price-display"
                                data-id="maitake">$70.00</span>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('maitake', -1)">-</button>
                                <input id="qty-maitake" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('maitake', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="product-card col-span-1 md:col-span-2" id="card-mixed-bundle">
                    <div class="flex flex-col md:flex-row h-full">
                        <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/learning-workshop.webp"
                            class="w-full md:w-1/3 h-56 md:h-auto object-cover">
                        <div class="p-8 flex flex-col justify-center flex-grow">
                            <h3 class="font-bold text-2xl">Variety Bundle (4 Blocks)</h3>
                            <p class="text-gray-500 mb-6 font-medium">Includes 1x each block: Lion's Mane, Shiitake,
                                Oyster, and Maitake. Total yield up to 5kg+ of mushrooms.</p>
                            <div class="flex justify-between items-center">
                                <span class="text-3xl font-bold text-[#3B7A57]">$180.00</span>
                                <div class="flex items-center gap-4">
                                    <button class="qty-btn" onclick="updateQty('mixed-bundle', -1)">-</button>
                                    <input id="qty-mixed-bundle" class="qty-input text-xl" value="0" readonly>
                                    <button class="qty-btn" onclick="updateQty('mixed-bundle', 1)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-20">
                <h2 class="text-3xl font-bold mb-8 text-center">Essential Grow Gear</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div class="product-card" id="card-humidity-tent">
                        <div class="p-6 flex items-center gap-6">
                            <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/grow-tent.webp"
                                class="w-24 h-24 rounded-xl object-cover">
                            <div class="flex-grow">
                                <h4 class="font-bold">Humidity Tent</h4>
                                <p class="text-sm text-gray-500">Reusable micro-climate tent.</p>
                                <p class="text-[#3B7A57] font-bold">$15.00</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('humidity-tent', -1)">-</button>
                                <input id="qty-humidity-tent" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('humidity-tent', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="product-card" id="card-starter-kit">
                        <div class="p-6 flex items-center gap-6">
                            <img src="https://s3.ap-southeast-2.amazonaws.com/durafungi.com/assets/img/Fine-Mist-Spray-Bottle.webp"
                                class="w-24 h-24 rounded-xl object-cover">
                            <div class="flex-grow">
                                <h4 class="font-bold">Starter Tool Kit</h4>
                                <p class="text-sm text-gray-500">Mist bottle + sanitiser.</p>
                                <p class="text-[#3B7A57] font-bold">$20.00</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="qty-btn" onclick="updateQty('starter-kit', -1)">-</button>
                                <input id="qty-starter-kit" class="qty-input" value="0" readonly>
                                <button class="qty-btn" onclick="updateQty('starter-kit', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-20 bg-gray-50 rounded-3xl p-8 md:p-12 text-center shadow-inner">
                <p id="totalDisplay" class="text-3xl font-bold mb-6">Total: $0.00</p>
                <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                    <input id="customerEmail" type="email" placeholder="Your email address"
                        class="px-6 py-4 rounded-full border w-full max-w-sm focus:ring-2 focus:ring-[#3B7A57] outline-none shadow-sm">
                    <button id="checkoutBtn" onclick="checkout()" disabled
                        class="bg-[#3B7A57] text-white px-12 py-4 rounded-full font-bold text-lg disabled:opacity-50 shadow-lg">Checkout
                        Now</button>
                </div>
                <p id="status-line" class="mt-4 text-sm text-gray-500 font-medium"></p>
            </div>
        </section>
    </main>

    <div id="sticky-bar">
        <span class="font-bold">Items in cart: <span id="totalItems">0</span></span>
        <button onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})"
            class="bg-white text-black px-6 py-2 rounded-full font-bold text-sm">Review Cart</button>
    </div>

    <footer class="bg-white py-12 text-center border-t text-gray-400 text-sm">© 2025 Dura Fungi. All rights reserved.
    </footer>

    <script>
        let checkoutMode = "payment";

        const products = {
            "blue-oyster": {
                payment: { price: 55.0, id: "price_1Sj3wIB03V57KY6Phjtx6CFQ" },
                subscription: { price: 44.0, id: "price_1Sj3wIB03V57KY6P5Qo8G0dm" }
            },
            "lions-mane": {
                payment: { price: 55.0, id: "price_1Sj48nB03V57KY6PTIaQA7bm" },
                subscription: { price: 44.0, id: "price_1Sj49rB03V57KY6P8Mta48Vo" }
            },
            "shiitake": {
                payment: { price: 60.0, id: "price_1Sj4EBB03V57KY6P7aPJk4Sb" },
                subscription: { price: 48.0, id: "price_1Sj4EeB03V57KY6PBgce7tE3" }
            },
            "maitake": {
                payment: { price: 70.0, id: "price_1Sj4HaB03V57KY6P0nriR4c4" },
                subscription: { price: 56.0, id: "price_1Sj4HaB03V57KY6PNTuJVdO5" }
            },
            "mixed-bundle": {
                payment: { price: 180.0, id: "price_1Sj4KHB03V57KY6PD22wNUsp" }
            },
            "humidity-tent": {
                payment: { price: 15.0, id: "price_1Sj4q9B03V57KY6PxInoLjWZ" }
            },
            "starter-kit": {
                payment: { price: 20.0, id: "price_1Sj4zrB03V57KY6PMuYhW3xN" }
            }
        };

        function toggleMenu() { document.getElementById('mobile-menu').classList.toggle('open'); }

        function isValidEmail(email) {
            return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(String(email || "").trim());
        }

        function setMode(mode) {
            checkoutMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');

            // Toggle body class for badge visibility
            document.getElementById('body-wrapper').className = `mode-${mode}`;

            document.querySelectorAll('.price-display').forEach(el => {
                const pid = el.dataset.id;
                if (products[pid][mode]) {
                    el.innerText = `$${products[pid][mode].price.toFixed(2)}`;
                } else {
                    el.innerText = `$${products[pid]['payment'].price.toFixed(2)}`;
                }
            });
            calculateTotal();
        }

        function updateQty(id, delta) {
            const input = document.getElementById(`qty-${id}`);
            let val = Math.max(0, parseInt(input.value) + delta);
            input.value = val;
            document.getElementById(`card-${id}`).classList.toggle('has-items', val > 0);
            calculateTotal();
            saveToStorage();
        }

        function calculateTotal() {
            let total = 0, count = 0;
            for (let key in products) {
                const qty = parseInt(document.getElementById(`qty-${key}`).value);
                if (qty > 0) {
                    const price = (checkoutMode === 'subscription' && products[key].subscription)
                        ? products[key].subscription.price
                        : products[key].payment.price;
                    total += qty * price;
                    count += qty;
                }
            }

            document.getElementById('totalDisplay').innerText = `Total: $${total.toFixed(2)}`;
            document.getElementById('totalItems').innerText = count;

            const email = document.getElementById('customerEmail').value.trim();
            const emailOk = isValidEmail(email);

            const canCheckout = count > 0 && (checkoutMode !== "subscription" || emailOk);
            document.getElementById('checkoutBtn').disabled = !canCheckout;

            document.getElementById('sticky-bar').classList.toggle('visible', count > 0);
        }

        const CART_KEY = "durafungi_cart_v1";

        function getCart() {
            try { return JSON.parse(localStorage.getItem(CART_KEY) || "{}"); }
            catch { return {}; }
        }

        function setCart(cart) {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
        }

        function addPriceToCart(priceId, qty = 1) {
            const cart = getCart();
            cart[priceId] = (parseInt(cart[priceId], 10) || 0) + (parseInt(qty, 10) || 0);
            setCart(cart);
        }

        function removePriceFromCart(priceId, qty = 1) {
            const cart = getCart();
            const next = (parseInt(cart[priceId], 10) || 0) - (parseInt(qty, 10) || 0);
            if (next <= 0) delete cart[priceId];
            else cart[priceId] = next;
            setCart(cart);
        }

        function cartItemsToStripeLineItems() {
            const cart = getCart();
            return Object.entries(cart)
                .map(([price, quantity]) => ({ price, quantity: parseInt(quantity, 10) || 0 }))
                .filter(x => x.quantity > 0);
        }

        function cartCount() {
            const cart = getCart();
            return Object.values(cart).reduce((sum, n) => sum + (parseInt(n, 10) || 0), 0);
        }

        async function checkout() {
            const email = document.getElementById('customerEmail').value.trim();
            const status = document.getElementById('status-line');
            const btn = document.getElementById('checkoutBtn');

            if (checkoutMode === "subscription" && !isValidEmail(email)) {
                alert("Please enter a valid email for subscriptions.");
                return;
            }

            const items = [];
            for (let key in products) {
                const qty = parseInt(document.getElementById(`qty-${key}`).value);
                if (qty > 0) {
                    const priceId = (checkoutMode === 'subscription' && products[key].subscription)
                        ? products[key].subscription.id
                        : products[key].payment.id;
                    items.push({ price: priceId, quantity: qty });
                }
            }

            try {
                // Preserve design/layout: only change button text temporarily (no class changes)
                btn.disabled = true;
                btn.dataset.dfOriginalText ??= btn.textContent;
                btn.textContent = "Redirecting to secure checkout…";
                status.innerText = "Redirecting to secure checkout...";

                const payload = {
                    checkoutMode,
                    items,
                    returnUrl: window.location.href
                };

                // Only send email when it's required (subscription)
                if (checkoutMode === "subscription" && isValidEmail(email)) {
                    payload.customerEmail = email;
                }

                const res = await fetch("https://api.durafungi.com/create-checkout-session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Server error (${res.status}): ${text}`);
                }

                const data = await res.json();
                if (data.url) {
                    // Best-practice UX: same-tab redirect
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || "Session generation failed.");
                }
            } catch (e) {
                alert("Checkout Error: " + e.message);

                // Restore UI state
                btn.disabled = false;
                btn.textContent = btn.dataset.dfOriginalText || "Checkout Now";
                status.innerText = "";
                calculateTotal();
            }
        }

        function saveToStorage() {
            const cart = {};
            for (let k in products) cart[k] = document.getElementById(`qty-${k}`).value;
            localStorage.setItem('block_cart', JSON.stringify(cart));
        }

        function loadStorage() {
            const saved = JSON.parse(localStorage.getItem('block_cart') || '{}');
            for (let k in saved) {
                if (document.getElementById(`qty-${k}`)) {
                    document.getElementById(`qty-${k}`).value = saved[k];
                    if (saved[k] > 0) document.getElementById(`card-${k}`).classList.add('has-items');
                }
            }
            calculateTotal();
        }

        window.onload = loadStorage;

        // Keep checkout button enabled state in sync with email field edits
        document.getElementById('customerEmail').addEventListener('input', calculateTotal);
    </script>
</body>

</html>